<html>
<head>
<title>Latest Kiting Weather for Wellington</title>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js" type="text/javascript"></script>
<script type="text/javascript">
//<![CDATA[
// global to keep track of update countdown
var clockTime = 0;

function get_ago_string(obsTime) {
  var d = new Date();
  var now = d.getTime()/1000.0;
  if (obsTime > now) {
    // Observation happened in future
    return false;
  }
  var diff = now - obsTime;
  return agostr(diff);

}

function agostr(secs) {
  var level=2;
  var out='';
  
  var periods = [365.25*24*60*60, 24*60*60, 60*60, 60, 1];
  var strings = ['y ','d ','h ','m ','s'];
  $.each(periods, function(i,period) {
      if (secs >= period && level > 0) {
        var num = parseInt(secs/period);
        out += num+strings[i];
        secs -= num*period;
        level--;
      }
  });

  return out;  
  
}

function buildData(data){
    // if data loaded, empty the table ready for values
    $('tbody#tablebody').html('');
    // loop through each site in turn
    $.each(data, function(i,item){
        var site = item['name'];
        var windSpeed = item['reading']['windSpeed'];
        var windDir = item['reading']['windDir'];
        var windCardinal = item['reading']['windCardinal'];
        var obsTime = item['reading']['obsTime'];
        var obsTimeFormatted = item['reading']['obsTimeFormatted'];
        var agoString = get_ago_string(obsTime);
        var link = item['link'];
        var htmlStr = '<tr><td>'+site+'</td><td>'+windSpeed+'</td><td>'+windDir+' ('+windCardinal+')</td><td>'+obsTimeFormatted+'</td><td>'+agoString+'</td><td><a href="'+link+'">Link</a></td></tr>';
        $('tbody#tablebody').html($('tbody#tablebody').html()+htmlStr );
    });
            
}

function updateClock() {
    var timeSecs = parseInt(clockTime/1000.0);
    
    var reading = (timeSecs > 0) ? agostr(timeSecs) : 'Loading...';

    $('#clock').html('Next update in '+reading);
}

function resetClock(when) {
    clockTime = when;
    updateClock();
}

function decrementClock() {
    clockTime -= 1000;
    updateClock();
}

function getTimeToUpdate() {
    
    // extra time to allow collection script to run
    // may need to adjust depending on how many external feeds are being pulled in
    // ideally we want it just long enough that collection script will always have run
    // just before ajax request
    var buffer=8000; // milliseconds
    
    // modify to match different cron schedule
    var now = new Date();
    
    // interval between cron calls in minutes
    var interval = 5;
    
    // split time into segments based on interval, then find the next
    // segment and calcuate the time to next update
    var currentTime = now.getMinutes()+now.getSeconds()/60;
    var segment = parseInt(currentTime / interval);
    var nextSegment = (segment+1)*interval;
    var timeToUpdate = (nextSegment - currentTime) * 60 * 1000 + buffer; // in milliseconds

    // simple sanity check to avoid overloading the browser
    if (timeToUpdate < 1000) {
        timeToUpdate = 1000;
    }

    resetClock(timeToUpdate);

    return timeToUpdate; 
}

function updateTable() {
    // get latest date from JSON and update the page
    var source="http://localhost:8888/kiting/data.json";
    $.ajax({
        url: source,
        dataType: "json",
        success: function(data,textStatus){
                if(textStatus=="success") {
                    var message = '';
                } else {
                    var message = 'Unspecified error loading data';
                }
                $('#msg').html(message);
                buildData(data);
            },
        error: function(xmlreq, textStatus, errorThrown) {
                console.log(textStatus,errorThrown);
                if (textStatus=="error") {
                    $('#msg').html('Error: Could not load data file');
                }
                if (textStatus=="parsererror") {
                    $('#msg').html('Error: Could not parse data file');
                }
                if (textStatus=="timeout") {
                    $('#msg').html('Error: Timeout while trying to loading data file');
                }
            }
    });

    var nextUpdate = getTimeToUpdate();
    if (nextUpdate && nextUpdate > 5000) {
        // call this function again to refresh table when new data is expected to have arrived
        setTimeout("updateTable()",nextUpdate);
    } else {
        // maximum refresh rate of once every 5 seconds
        setTimeout("updateTable()",5000);
    }
}

$(document).ready(function() {
    // Show loading indicator
    $('tbody#tablebody').html('<tr><td colspan="6"><strong>Loading data...</strong></td></tr>');
    
    updateTable();
    setInterval("decrementClock()",1000);
    

});
//]]>
</script>
</head>
<body>

<p id="msg"></p>
<p id="clock">&nbsp;</p>

<table border="1">
 <thead>
  <tr>
   <th>Location</th>
   <th>Wind Speed (knots)</th>
   <th>Wind Direction (degrees)</th>
   <th>Observation Time</th>
   <th>Time Ago</th>
   <th>Source</th>
  </tr>
 </thead>
 <tbody id="tablebody">

 </tbody>
</table>

</body>
</html>